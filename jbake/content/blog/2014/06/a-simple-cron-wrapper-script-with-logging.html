title=A simple cron wrapper script with logging
date=2014-06-04
type=post
tags=crontab
status=published
~~~~~~
When working with crontab service, one thing I often need is to capture the ouput of the job. Having the job script aware of this output and logging is tedious, and often make the script harder to read. So I wrote a shell wrapper that will redirect all job script's STDOUT into a log file. This way I can inspect it when a job has run and the job script can just focus on the task itself. <br />
<br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;"># file: runcmd.sh<br /># Helper/wrapper script to run any command in the crontab env. This script will ensure<br /># user profile script is loaded and to log any command output into log files. It also<br /># ensure not to print anything to STDOUT to avoid crontab system mail alert.<br />#<br /># NOTE: be sure to pass in absolute path of the command to be run so it can be found.<br />#<br /># Usage:<br />#&nbsp;&nbsp; ./runcmd.sh find $HOME/crontab/test.sh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Simple use case<br />#&nbsp;&nbsp; LOG_NAME=mytest ./runcmd.sh $HOME/crontab/test.sh # Change the log name to something specific<br />#<br /><br /># Options<br />DIR=`dirname $0`<br />CMD="$@"<br />CMD_NAME=`basename $1`<br />LOG_NAME=${LOG_NAME:=$CMD_NAME}<br />LOG="$DIR/logs/$LOG_NAME.log`date +%s`"<br /><br /># Ensure logs dir exists<br />if [[ ! -e $DIR/logs ]]; then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mkdir -p $DIR/logs<br />fi<br /><br /># Run cron command<br />source $HOME/.bash_profile<br />echo "`date` Started cron cmd=$CMD, logname=$LOG_NAME" &gt;&gt; $LOG 2&gt;&amp;1<br />$CMD &gt;&gt; $LOG 2&gt;&amp;1<br />echo "`date` Cron cmd is done." &gt;&gt; $LOG 2&gt;&amp;1</span><br />
<br />
With this wrapper, you can run any shell script and their output will be recorded. For example this job script below will clean up the logs accumulated in our logs folder.<br />
<br />
Note that the wrapper will also auto source the ".bash_profile". Often this this is needed if your job script expect all the env variables you already have setup in your login shell scripts.<br />
<br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;"># file: </span><span style="font-family: &quot;Courier New&quot;,Courier,monospace;"><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">remove-crontab-logs.sh</span> </span><br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">DIR=`dirname $0`/logs<br />echo "Checking and removing logs in $DIR"<br />find $DIR -type f -mtime +31 -print -delete<br />echo "Done"</span><br />
<br />
Now in the crontab file, you may run the job script like this:<br />
<br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;"># Clean up crontab logs<br />@montly $HOME/crontab/runcmd.sh $HOME/crontab/remove-crontab-logs.sh</span><br />
<br />
<br />